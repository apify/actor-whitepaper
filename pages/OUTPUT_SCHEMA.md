# Output Schema File

A JSON file that defines structure of the output generated by
Actor (see [Input and Output](../README.md#input-and-output) for details).
The file is referenced from the main [Actor file](ACTOR.md) using the `output` directive,
and it is typically stored in `.actor/output_schema.json`.

Note that the schema is not only used to generate UI, but also the output JSON object,
with fields corresponding to `properties`, whose values are URLs to the results, data or liveview.
Such output object needs to be generated by system right when the Actor starts,
and remain static over entire lifetime of Actor.

**NOTE:** The output schema should enable developers to define schema for the
default dataset and key-value store. But how? It should be declarative
so that the system can check that e.g. the overridden default dataset
has the right schema. But then, when it comes to kv-store, that's not purely
output object but INPUT, similarly for overridden dataset or request queue.
Perhaps the cleanest way would be to set these directly in `.actor/actor.json`.

**TODOs (@jancurn):**
- Should we enforce users to have at least one item with `visible: true`?  
  Or what about doing it the opposite
  way and letting the user choose what should not be visible?
- The Run Sync API could have an option to automatically return (or redirect to?)
  a specific property (i.e. URL) of the output object.
  This would supersede the `outputRecordKey=OUTPUT` API param as well as
  the run-sync-get-dataset-items API endpoint.
  Maybe we could have one of the output properties as the main one,
  which would be used by default for this kind of API endpoint, and just return
  data to user.

NOTE: We decided that output schema can reference other datasets/kv-stores/queues
but only those ones that are referenced in the input, or the default. Hence
there's no point to include storage schema here again, as it's done elsewhere.

## Structure

```jsonc
{
  "actorSpecification": 1,
  "title": "Some title", // optional
  "description": "Text that is shown in the Output UI", // optional
  "properties": {
    // Default dataset contains all the scraped products
    // In the "output" object, the field should be a link to dataset with the right view
    "currentProducts": {
      "type": "dataset",
      "views": ["productVariants"] // optional, default means all views in dataset
      // If the user wants to use an existing dataset,
      // they should reference it from input:
      "target": "$input.myProductsDatasetId" //optional
    },

    // Selects a specific group of records with a certain prefix. In UI, this can be shown
    // as a list of images. In the output object, this will be a link to a API with "prefix" param.
    "productImages": {
      "type": "key-value-store",
      "title": "Product images", //optional
      "description": "Yaddada", //optional
      "collections": ["screenshots"] // optional, default means all collections in key-value-store
    },
    
    // If the users want to reference a single file, they do it via selecting a collection
    // that displays only a single file. In the output object, the result should be a link to file.
    "summaryReportView": {
      "type": "key-value-store",
      "title": "API server", // optional
      "collections": ["monitoringReport"],
      "target": "default" //optional
    },

    // Live view
    // In the "output" object, the result should be a link to live view URL
    "apiServer": {
      "type": "live-view",
      "title": "API server", // optional
      "description": "API documentation is available in swagger.com/api/xxxx", // optional
      "path": "/nice-report?query=123",
      // IDEA: In the future, we could perhaps work with the API/swagger schema on more advanced level,
      // but it might be an overkill
      "schema": "TODO"
    }
  }
}
```

## Examples of ideal Actor run UI

- For the majority of Actors, we want to see the dataset with new records being added in realtime
- For [Google Spreadsheet Import](https://apify.com/lukaskrivka/google-sheets),
  we want to first display Live View for the user to set up OAUTH, and once 
   this is set up, then we want to display the log next time.
- For technical Actors, it might be a log
- For [HTML to PDF convertor](https://apify.com/jancurn/url-to-pdf) it's a single record from key-value store
- For [Monitoring](https://apify.com/apify/monitoring-runner) it's log during the runtime and a single HTML record in an iframe in the end
- For an Actor that has failed, it's the log
  (JC: Really? I'd want to see incomplete results. I can check log anytime)

## How to define Actor run UI

### Simple version

There will be a new tab on Actor run detail for every Actor with output schema called "Output".
This tab will be at the first position and displayed by default. Tab will show the following:
- Items from output schema with property `visible: true` will be rendered in the same order
  as they are in schema
- The live view will be displayed only when it has `visible: true` and when it's active.
  Otherwise, we should show just a short message "This show is over".
- If the dataset has more views then we should have some select or tabs to select the view

### Ideal most comprehensive state

- Default setup, i.e., what output components should be displayed at the default run tab
- Optionally, the setup for different states
- Be able to pragmatically changes this using API by Actor itself


## OUTPUT.json

```jsonc
{
    "title": "Some title",
    "description": "Some description",
    "properties": {
        "currentProducts": {
            "id": "lkspwWd8dFknjkxx",
            "type": "dataset",
            "url": "https://api.apify.com/datasets/lkspwWd8dFknjkxx",
            "views": {
                "productVariants": {
                    "title": "Product variants",
                    "description": "yadayada",
                    "url": "https://api.apify.com/datasets/lkspwWd8dFknjkxx/?view=productVariants"
                 }
            }
        },
        "productImages": {
            "id": "FkspwWd8dFknjkxx",
            "type": "key-value-store",
            "title": "Product images",
            "description": "Yaddada",
            "url": "https://api.apify.com/key-value-stores/FkspwWd8dFknjkxx",
            "collections": {
                "screenshots": {
                    "title": "...",
                    "description": "...",
                    "url": "https://api.apify.com/key-value-stores//lkspwWd8dFknjkxx/?collection=screenshots"
                }
            }
        }
    }
}
```


NOTEs

Same as we show Output in UI, we need to autogenerate the OUTPUT in API e.g. JSON format.
There would be properties like in the output_schema.json file, with e.g. URL to dataset,
log file, kv-store, live view etc. So it would be an auto-generated field "output"
that we can add to JSON returned by the Run API enpoints
(e.g. https://docs.apify.com/api/v2#/reference/actor-tasks/run-collection/run-task)
- Also see: https://github.com/apify/actor-specs/pull/5#discussion_r775641112
- `output` will be a property of run object generated from Output schema
